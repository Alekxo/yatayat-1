<html>
<head>
    <title> Kathmandu Public Transport </title>
<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="[path-to-dist]/leaflet.ie.css" />
<![endif]-->
</head>
<body>
<div id="publicTransportMap" style="width: 600px; height: 400px">
<script src="lib/jquery-1.7.2.min.js"></script>
<script src="lib/underscore-min.js"></script>
<script src="lib/leaflet/leaflet.js"></script>
<script src="yatayat.js"></script>
<script type="text/javascript" language="javascript">
    // initialize the map
    var map = new L.Map('publicTransportMap');

    //var ktmBB = "85.2885,27.6839,85.3368,27.7299";
    //var api_url = 'http://www.overpass-api.de/api/interpreter';
    var api_url = 'sample/routes.xml';
    var osmdata;
    var query_string = '<osm-script> <union> <query type="relation"> <has-kv k="type" v="route"/> <bbox-query s="27.6839" n="27.7299" w="85.2885" e="85.3368,"/> </query> <recurse type="relation-way"/> <recurse type="way-node"/> </union> <print/> </osm-script>';
    $.ajax({ type: 'POST', url: api_url, 
             data: query_string,
             dataType: 'text',
             success:
    function(data) {
        osmdata = data;
        osmToYY(data).forEach(function(route) {
            YY.render(route, map);
        });
        //console.log(osmToYY(data));
    }});

    // Alternative layerings:
    // http://{s}.tile.cloudmade.com/[API-key]/997/256/
    // http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png
    var tiles = new L.TileLayer('http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
    attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">',
    maxZoom: 18
    });

    // add the layer to the map, set the view to a given place and zoom
    map.addLayer(tiles).setView(new L.LatLng(27.7, 85.3), 13);

        // // testing
        // YY.test_map = map;
        // var script = document.createElement('script');
        // script.setAttribute('src', 'sample/test.js');
        // document.body.appendChild(script);

    function osmToYY(overpassXML) {
        var nodes = {};
        var segments = {};
        var tagToObj = function(tag) {
            tags = {};
            _.each(tag, function (t) { 
                $t = $(t);
                tags[$t.attr('k')] = $t.attr('v'); });
            return tags; 
        };
        _.each($(overpassXML).find('node'), function(n) {
            $n = $(n);
            nodes[$n.attr('id')] = {lat: $n.attr('lat'),
                                    lng: $n.attr('lon'), 
                                    tag: tagToObj(n.tag)};
        });
        _.each($(overpassXML).find('way'), function(w) {
            $w = $(w);
            segments[$w.attr('id')] = new YY.Segment(
                _.map($w.find('nd'),function(n) { 
                    $n = $(n);
                    return [nodes[$n.attr('ref')].lat,
                            nodes[$n.attr('ref')].lng]; 
                }), tagToObj($w.find('tag')));
        });
        routes = _.map($(overpassXML).find('relation'), function(r) {
            $r = $(r);
            myStops = [];
            mySegments = [];
            _.each($r.find('member'), function(m) {
                $m = $(m); 
                if($m.attr('type') === 'way') {
                    mySegments.push(segments[$m.attr('ref')]);
                } else if ($m.attr('type') === 'node') {
                    $n = $(nodes[$m.attr('ref')]);
                    //if($n.find('tag')public_transportation === 'stop_position') 
                    myStops.push([$n.attr('lat'), $n.attr('lng')]);
                } 
            });
            return new YY.Route(myStops, mySegments, tagToObj($r.find('tag')));
        });
        return routes;
    }
     
</script>
</body>
</html>
